<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administración de Horarios</title>
  <link rel="stylesheet" href="estilos.css" />
  <style>
    /* colores de los modos */
    .mode-btn#modoVac { background: #4da6ff; color: #fff; }
    .mode-btn#modoInc { background: #cc0000; color: #fff; }
    .mode-btn#modoCum { background: #ffcc00; color: #000; }
    /* Listo: gris claro */
    .mode-btn#modoClear { background: #e0e0e0; color: #333; display: none; }

    .mode-btn {
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      margin-left: 0.5rem;
      cursor: pointer;
    }
    .mode-btn.active {
      box-shadow: 0 0 0 3px rgba(0,0,0,0.2);
    }
    /* Estilos para los nuevos estados de celda */
    td.vacaciones {
      background-color: #4da6ff;   /* un azul claro para vacaciones */
      color: #fff;
    }
    td.incapacidad {
      background-color: #cc0000;   /* rojo para incapacidad */
      color: #fff;
    }
    td.cumpleaños {
      background-color: #ffcc00;   /* amarillo para cumpleaños */
      color: #000;
    }

  </style>
</head>
<body>

<nav class="navbar">
  <div class="nav-container">
    <span class="nav-logo">Linea 8</span>
    <div class="nav-links">
      <a href="index.html" class="nav-link">Operadores</a>
      <a href="ing.html" class="nav-link">Ingenieros de Proceso</a>
      <a href="admin.html" class="nav-link">Administrar Horarios</a>
    </div>
  </div>
</nav>

<h1>Administración de Horarios</h1>
<div id="authMessage" class="message"></div>
<div id="adminContent" style="display:none;">
  <div class="controls">
    <button id="prev">« Semana anterior</button>
    <button id="next">Semana siguiente »</button>
    <label>Fecha:<input type="date" id="weekInput" /></label>
    <button id="load">Cargar semana</button>
    <button id="saveChanges">Guardar cambios</button>
    <!-- botones de modo -->
    <button class="mode-btn" id="modoVac">Vacaciones</button>
    <button class="mode-btn" id="modoInc">Incapacidad</button>
    <button class="mode-btn" id="modoCum">Cumpleaños</button>
    <!-- listo -->
    <button class="mode-btn" id="modoClear">Listo</button>
  </div>
  <div id="message" class="message"></div>
  <table id="overrideTable"></table>
</div>

<script>
  const PASSWORD='babayaga';
  const OWNER='diochos', REPO='horario-operadores', PATH='overrides.csv';
  const baseSchedule=[
    [1,1,1,1,0,0],[1,1,0,0,1,1],[0,0,1,1,1,1],[1,1,1,0,0,1],
    [0,1,1,1,1,0],[1,0,0,1,1,1],[1,1,1,0,0,1],[0,0,1,1,1,1],
    [1,1,0,1,1,0],[0,1,1,0,1,1]
  ];
  let scheduleMap={}, overrideMap={}, weeks=[], currentMonday, GITHUB_TOKEN;
  let currentMode='toggle'; // 'toggle','vac','inc','cum'

  function fmtDate(d){
    const dd=('0'+d.getDate()).slice(-2),
          mm=('0'+(d.getMonth()+1)).slice(-2);
    return `${dd}/${mm}/${d.getFullYear()}`;
  }
  function getMonday(d){
    const dt=new Date(d);
    dt.setDate(dt.getDate() - ((dt.getDay()+6)%7));
    dt.setHours(0,0,0,0);
    return dt;
  }

  async function loadData(){
    let res=await fetch('schedule.csv');
    if(!res.ok) return alert('schedule.csv no encontrado');
    let rows=(await res.text()).trim().split(/\r?\n/).map(r=>r.split(','));
    rows.slice(1).forEach(r=>{
      const [date,...names]=r;
      scheduleMap[date]=names;
      weeks.push(date);
    });
    // overrides sin cache
    res=await fetch('overrides.csv?ts='+Date.now(),{cache:'no-store'});
    if(!res.ok) return;
    let orows=(await res.text()).trim().split(/\r?\n/).map(r=>r.split(','));
    overrideMap={};
    orows.slice(1).forEach(r=>{
      const [date,pos,day,val]=r;
      overrideMap[date]=overrideMap[date]||{};
      overrideMap[date][pos]=overrideMap[date][pos]||{};
      overrideMap[date][pos][day]=Number(val);
    });
  }

  function renderTable(dateKey){
    const tbl=document.getElementById('overrideTable'),
          msg=document.getElementById('message');
    tbl.innerHTML=''; msg.textContent='';
    const names=scheduleMap[dateKey];
    if(!names) return msg.textContent='Semana no disponible';

    // header
    let hdr='<tr><th>Operador</th>';
    ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'].forEach((dn,i)=>{
      const d=new Date(currentMonday);
      d.setDate(d.getDate()+i);
      hdr+=`<th>${dn}<br>${fmtDate(d)}</th>`;
    });
    hdr+='<th>Hrs</th></tr>';
    tbl.innerHTML=`<thead>${hdr}</thead><tbody></tbody>`;
    const tb=tbl.querySelector('tbody');

    names.forEach((name,pos)=>{
      let hrs=0, row=`<tr><td>${name}</td>`;
      for(let d=0;d<7;d++){
        let st=(d<6&&baseSchedule[pos][d]===1)?1:0;
        const ov=overrideMap[dateKey]?.[pos]?.[d];
        if(ov!==undefined) st=ov;
        if(st===1) hrs+=12;
        const cls= st===1?'work':
                   st===0?'rest':
                   st===2?'vacaciones':
                   st===3?'incapacidad':'cumpleaños';
        const txt= st===1?'Turno':
                   st===0?'Descanso':
                   st===2?'Vacaciones':
                   st===3?'Incapacidad':'Cumpleaños';
        row+=`<td class="${cls}" data-pos="${pos}" data-day="${d}">${txt}</td>`;
      }
      row+=`<td>${hrs}</td></tr>`;
      tb.insertAdjacentHTML('beforeend',row);
    });

    // clicks
    tb.querySelectorAll('td[data-pos]').forEach(td=>{
      td.onclick=()=>{
        const pos=td.dataset.pos, day=td.dataset.day, date=dateKey;
        overrideMap[date]=overrideMap[date]||{};
        overrideMap[date][pos]=overrideMap[date][pos]||{};
        if(currentMode==='toggle'){
          const cur=overrideMap[date][pos][day] ?? ((day<6&&baseSchedule[pos][day]===1)?1:0);
          overrideMap[date][pos][day]=cur===1?0:1;
        } else {
          const mapMode={vac:2,inc:3,cum:4};
          overrideMap[date][pos][day]=mapMode[currentMode];
        }
        // refresca celda
        const st=overrideMap[date][pos][day];
        const cls= st===1?'work':
                   st===0?'rest':
                   st===2?'vacaciones':
                   st===3?'incapacidad':'cumpleaños';
        const txt= st===1?'Turno':
                   st===0?'Descanso':
                   st===2?'Vacaciones':
                   st===3?'Incapacidad':'Cumpleaños';
        td.className=cls;
        td.textContent=txt;
      };
    });
  }

  async function saveChanges(){
    const msgEl=document.getElementById('message');
    msgEl.style.color='var(--color-primary)';
    msgEl.textContent='Guardando…';
    const dateKey=fmtDate(currentMonday);
    let csv='Fecha,Pos,Day,Val\n';
    Object.entries(overrideMap).forEach(([date,posMap])=>{
      Object.entries(posMap).forEach(([pos,days])=>{
        Object.entries(days).forEach(([day,val])=>{
          csv+=`${date},${pos},${day},${val}\n`;
        });
      });
    });
    // ... PUT a GitHub idéntico al anterior ...
    renderTable(dateKey);
    msgEl.style.color='var(--color-success)';
    msgEl.textContent='Cambios guardados y aplicados.';
  }

  document.addEventListener('DOMContentLoaded',async()=>{
    const pwd=prompt('Ingrese contraseña:');
    if(pwd!==PASSWORD){
      document.getElementById('authMessage').textContent='Acceso denegado';
      return;
    }
    // token...
    document.getElementById('adminContent').style.display='block';
    await loadData();
    currentMonday=getMonday(new Date());
    document.getElementById('weekInput').value=currentMonday.toISOString().slice(0,10);
    renderTable(fmtDate(currentMonday));

    // navegación
    document.getElementById('prev').onclick=()=>{ currentMonday.setDate(currentMonday.getDate()-7); document.getElementById('weekInput').value=currentMonday.toISOString().slice(0,10); renderTable(fmtDate(currentMonday)); };
    document.getElementById('next').onclick=()=>{ currentMonday.setDate(currentMonday.getDate()+7); document.getElementById('weekInput').value=currentMonday.toISOString().slice(0,10); renderTable(fmtDate(currentMonday)); };
    document.getElementById('load').onclick=()=>{ const d=new Date(document.getElementById('weekInput').value); currentMonday=getMonday(d); renderTable(fmtDate(currentMonday)); };
    document.getElementById('saveChanges').onclick=saveChanges;

    // modos
    const btnVac=document.getElementById('modoVac'),
          btnInc=document.getElementById('modoInc'),
          btnCum=document.getElementById('modoCum'),
          btnClear=document.getElementById('modoClear'),
          allModes=[btnVac,btnInc,btnCum];
    function enterMode(mode,btn){
      currentMode=mode;
      allModes.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      btnClear.style.display='inline-block';
    }
    btnVac.onclick=()=>enterMode('vac',btnVac);
    btnInc.onclick=()=>enterMode('inc',btnInc);
    btnCum.onclick=()=>enterMode('cum',btnCum);
    btnClear.onclick=()=>{
      currentMode='toggle';
      allModes.forEach(b=>b.classList.remove('active'));
      btnClear.style.display='none';
    };
  });
</script>
</body>
</html>
