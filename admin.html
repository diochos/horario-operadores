<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administración de Horarios</title>
  <link rel="stylesheet" href="estilos.css" />
</head>
<body>

  <nav class="navbar">
    <div class="nav-container">
      <span class="nav-logo">Linea 8</span>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Operadores</a>
        <a href="ing.html"  class="nav-link">Ingenieros de Proceso</a>
        <a href="admin.html" class="nav-link">Administrar Horarios</a>
      </div>
    </div>
  </nav>

  <h1>Administración de Horarios</h1>
  <div id="authMessage" class="message"></div>
  <div id="adminContent" style="display:none;">
    <div class="controls">
      <button id="prev">« Semana anterior</button>
      <button id="next">Semana siguiente »</button>
      <label>Fecha:<input type="date" id="weekInput" /></label>
      <button id="load">Cargar semana</button>
      <button id="saveChanges">Guardar cambios</button>
    </div>
    <div id="message" class="message"></div>
    <table id="overrideTable"></table>
  </div>

  <script>
    const PASSWORD = 'babayaga';
    const OWNER = 'diochos';
    const REPO = 'horario-operadores';
    const PATH = 'overrides.csv';

    const baseSchedule = [
      [1,1,1,1,0,0],[1,1,0,0,1,1],[0,0,1,1,1,1],[1,1,1,0,0,1],
      [0,1,1,1,1,0],[1,0,0,1,1,1],[1,1,1,0,0,1],[0,0,1,1,1,1],
      [1,1,0,1,1,0],[0,1,1,0,1,1]
    ];

    let scheduleMap = {}, overrideMap = {}, weeks = [], currentMonday, GITHUB_TOKEN;

    function fmtDate(d) {
      const dd = ('0'+d.getDate()).slice(-2);
      const mm = ('0'+(d.getMonth()+1)).slice(-2);
      return `${dd}/${mm}/${d.getFullYear()}`;
    }
    function getMonday(d) {
      const dt = new Date(d.getTime());
      dt.setDate(dt.getDate() - ((dt.getDay()+6)%7));
      dt.setHours(0,0,0,0);
      return dt;
    }

    async function loadData() {
      // cargar schedule.csv
      let res = await fetch('schedule.csv');
      if (!res.ok) return alert('schedule.csv no encontrado');
      let rows = (await res.text()).trim().split(/\r?\n/).map(r=>r.split(','));
      rows.slice(1).forEach(r => {
        const date = r[0], names = r.slice(1);
        scheduleMap[date] = names;
        weeks.push(date);
      });

      // cargar overrides.csv local sin usar API
      res = await fetch(PATH);
      if (!res.ok) return;  // si no existe o 401, ignorar
      let orows = (await res.text()).trim().split(/\r?\n/).map(r=>r.split(','));
      overrideMap = {};
      orows.slice(1).forEach(r => {
        const [date,pos,day,val] = r;
        overrideMap[date] = overrideMap[date]||{};
        overrideMap[date][pos] = overrideMap[date][pos]||{};
        overrideMap[date][pos][day] = (val==='1');
      });
    }

    function renderTable(dateKey) {
      const tbl = document.getElementById('overrideTable'),
            msg = document.getElementById('message');
      tbl.innerHTML = ''; msg.textContent = '';
      const names = scheduleMap[dateKey];
      if (!names) return msg.textContent='Semana no disponible';

      // encabezado
      let hdr = '<tr><th>Operador</th>';
      ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'].forEach((dn,i)=>{
        const d = new Date(currentMonday);
        d.setDate(d.getDate()+i);
        hdr += `<th>${dn}<br>${fmtDate(d)}</th>`;
      });
      hdr += '<th>Hrs</th></tr>';
      tbl.innerHTML = `<thead>${hdr}</thead><tbody></tbody>`;

      const tb = tbl.querySelector('tbody');
      names.forEach((name,pos)=>{
        let hrs=0, row=`<tr><td>${name}</td>`;
        for(let d=0;d<7;d++){
          let work = d<6 && baseSchedule[pos][d]===1;
          const ov = overrideMap[dateKey]?.[pos]?.[d];
          if (ov!==undefined) work=ov;
          if (work) hrs+=12;
          row += `<td class="${work?'work':'rest'}" data-pos="${pos}" data-day="${d}">${work?'Turno':'Descanso'}</td>`;
        }
        row += `<td>${hrs}</td></tr>`;
        tb.insertAdjacentHTML('beforeend',row);
      });

      tb.querySelectorAll('td[data-pos]').forEach(td=>{
        td.onclick = ()=>{
          const pos=td.dataset.pos, day=td.dataset.day, date=dateKey;
          overrideMap[date] = overrideMap[date]||{};
          overrideMap[date][pos] = overrideMap[date][pos]||{};
          const cur = overrideMap[date][pos][day];
          overrideMap[date][pos][day] = cur===undefined ? !(baseSchedule[pos][day]===1) : !cur;
          const w = overrideMap[date][pos][day];
          td.textContent = w?'Turno':'Descanso';
          td.className = w?'work':'rest';
        };
      });
    }

   async function saveChanges() {
  const msgEl = document.getElementById('message');
  msgEl.textContent = 'Guardando…'; msgEl.style.color = 'var(--color-primary)';

  // Construye el CSV igual que antes
  const dateKey = fmtDate(currentMonday);
  let csv = 'Fecha,Pos,Day,Val\n';
  Object.entries(overrideMap).forEach(([date,posMap])=>{
    Object.entries(posMap).forEach(([pos,days])=>{
      Object.entries(days).forEach(([day,val])=>{
        csv += `${date},${pos},${day},${val?1:0}\n`;
      });
    });
  });

  const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
  try {
    // Primer HEAD para obtener SHA (si existe)
    let r = await fetch(apiUrl, {
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        Accept: 'application/vnd.github.v3+json'
      }
    });
    let sha = null;
    if (r.ok) {
      const meta = await r.json();
      sha = meta.sha;
    } else if (r.status !== 404) {
      throw new Error(`Lectura overrides.csv: ${r.status}`);
    }

    // Prepara payload
    const content = btoa(unescape(encodeURIComponent(csv)));
    const payload = { message:`Actualiza overrides ${dateKey}`, content };
    if (sha) payload.sha = sha;

    // PUT para guardar
    r = await fetch(apiUrl, {
      method: 'PUT',
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        Accept: 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(`PUT overrides.csv: ${r.status}`);

    // **Optimistic render:** lo que ya tienes en overrideMap, sin recargar desde GitHub
    renderTable(dateKey);

    msgEl.style.color = 'var(--color-success)';
    msgEl.textContent = 'Cambios guardados y aplicados en pantalla.';
  } catch(e) {
    msgEl.style.color = 'red';
    msgEl.textContent = `Error guardando: ${e.message}`;
  }
}

    document.addEventListener('DOMContentLoaded',async()=>{
      const pwd=prompt('Ingrese contraseña:');
      if(pwd!==PASSWORD){
        document.getElementById('authMessage').textContent='Acceso denegado';
        return;
      }
      GITHUB_TOKEN = localStorage.getItem('gh_pat');
      if(!GITHUB_TOKEN){
        const tok = prompt('Ingresa tu PAT con scope repo:');
        if(!tok){
          document.getElementById('authMessage').textContent='Token requerido';
          return;
        }
        GITHUB_TOKEN=tok;
        localStorage.setItem('gh_pat',tok);
      }

      document.getElementById('adminContent').style.display='block';
      await loadData();

      let mon = getMonday(new Date());
      if(!scheduleMap[fmtDate(mon)]) mon = getMonday(new Date(weeks[0].split('/').reverse().join('-')));
      currentMonday = mon;
      document.getElementById('weekInput').value = currentMonday.toISOString().slice(0,10);
      renderTable(fmtDate(currentMonday));

      document.getElementById('prev').onclick = ()=>{
        currentMonday.setDate(currentMonday.getDate()-7);
        document.getElementById('weekInput').value = currentMonday.toISOString().slice(0,10);
        renderTable(fmtDate(currentMonday));
      };
      document.getElementById('next').onclick = ()=>{
        currentMonday.setDate(currentMonday.getDate()+7);
        document.getElementById('weekInput').value = currentMonday.toISOString().slice(0,10);
        renderTable(fmtDate(currentMonday));
      };
      document.getElementById('load').onclick = ()=>{
        const d = new Date(document.getElementById('weekInput').value);
        currentMonday = getMonday(d);
        renderTable(fmtDate(currentMonday));
      };
      document.getElementById('saveChanges').onclick = saveChanges;
    });
  </script>
</body>
</html>
