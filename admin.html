<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administración de Horarios</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1 { margin-bottom: .5rem; }
    .controls { margin-bottom: 1rem; }
    .controls button, .controls input { margin-right: 1rem; padding: .25rem; }
    .message { color: red; margin-bottom: 1rem; }
    table { border-collapse: collapse; width: 100%; max-width: 800px; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; white-space: nowrap; }
    th { background: #f0f0f0; }
    .work { background: #8f8; cursor: pointer; }
    .rest { background: #f88; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Administración de Horarios</h1>
  
  <div id="authMessage" class="message"></div>
  <div id="adminContent" style="display:none;">
    <div class="controls">
      <button id="prev">« Semana anterior</button>
      <button id="next">Semana siguiente »</button>
      <label>Fecha:<input type="date" id="weekInput" /></label>
      <button id="load">Cargar semana</button>
      <button id="saveChanges">Guardar cambios</button>
    </div>
    <div id="message" class="message"></div>
    <table id="overrideTable"></table>
  </div>

  <script>
    // Configuración
    const PASSWORD     = 'babayaga';
    const OWNER        = 'diochos';
    const REPO         = 'horario-operadores';
    const PATH         = 'overrides.csv';
    const GITHUB_TOKEN = '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';

    const baseSchedule = [
      [1,1,1,1,0,0],[1,1,0,0,1,1],[0,0,1,1,1,1],[1,1,1,0,0,1],
      [0,1,1,1,1,0],[1,0,0,1,1,1],[1,1,1,0,0,1],[0,0,1,1,1,1],
      [1,1,0,1,1,0],[0,1,1,0,1,1]
    ];

    let scheduleMap = {}, overrideMap = {}, weeks = [], currentMonday;

    function fmtDate(d) {
      const dd = ('0' + d.getDate()).slice(-2);
      const mm = ('0' + (d.getMonth() + 1)).slice(-2);
      return `${dd}/${mm}/${d.getFullYear()}`;
    }

    function getMonday(d) {
      const dt = new Date(d.getTime());
      const diff = (dt.getDay() + 6) % 7;
      dt.setDate(dt.getDate() - diff);
      dt.setHours(0,0,0,0);
      return dt;
    }

    async function loadData() {
      // Carga schedule.csv
      let res = await fetch('schedule.csv');
      if (!res.ok) { alert('schedule.csv no encontrado'); return; }
      const text = await res.text();
      const rows = text.trim().split(/\r?\n/).map(r => r.split(',').map(c => c.trim()));
      rows.slice(1).forEach(r => { scheduleMap[r[0]] = r.slice(1); weeks.push(r[0]); });

      // Carga overrides.csv si existe
      res = await fetch(PATH);
      if (res.ok) {
        const orows = (await res.text()).trim().split(/\r?\n/).map(r => r.split(',').map(c => c.trim()));
        orows.slice(1).forEach(r => {
          const [date,pos,day,val] = r;
          overrideMap[date] = overrideMap[date] || {};
          overrideMap[date][pos] = overrideMap[date][pos] || {};
          overrideMap[date][pos][day] = val === '1';
        });
      }
    }

    function renderTable(date) {
      const tbl = document.getElementById('overrideTable');
      const msg = document.getElementById('message');
      tbl.innerHTML = '';
      msg.textContent = '';

      const names = scheduleMap[date];
      if (!names) { msg.textContent = 'Semana no disponible'; return; }

      // Encabezado
      let hdr = '<tr><th>Operador</th>';
      ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'].forEach(d => hdr += `<th>${d}</th>`);
      hdr += '<th>Hrs</th></tr>';
      tbl.innerHTML = `<thead>${hdr}</thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');

      // Filas
      names.forEach((name,pos) => {
        let hrs = 0;
        let row = `<tr><td>${name}</td>`;
        for (let d = 0; d < 7; d++) {
          let work = (d < 6 && baseSchedule[pos][d] === 1);
          const ov = overrideMap[date] && overrideMap[date][pos] && overrideMap[date][pos][d];
          if (ov !== undefined) work = ov;
          if (work) hrs += 12;
          row += `<td class="${work?'work':'rest'}" data-pos="${pos}" data-day="${d}">${work?'Turno':'Descanso'}</td>`;
        }
        row += `<td>${hrs}</td></tr>`;
        tb.insertAdjacentHTML('beforeend', row);
      });

      // Toggle click
      tb.querySelectorAll('td[data-pos]').forEach(td => td.addEventListener('click', () => {
        const pos = td.dataset.pos;
        const day = td.dataset.day;
        const date = fmtDate(currentMonday);
        overrideMap[date] = overrideMap[date] || {};
        overrideMap[date][pos] = overrideMap[date][pos] || {};
        const cur = overrideMap[date][pos][day];
        overrideMap[date][pos][day] = cur === undefined ? !(baseSchedule[pos][day] === 1) : !cur;
        const w = overrideMap[date][pos][day];
        td.textContent = w ? 'Turno' : 'Descanso';
        td.className = w ? 'work' : 'rest';
      }));
    }

    async function saveChanges() {
      const msgEl = document.getElementById('message'); msgEl.textContent = ''; msgEl.style.color = 'red';
      const dateKey = fmtDate(currentMonday);

      let csv = 'Fecha,Pos,Day,Val\n';
      Object.entries(overrideMap).forEach(([date,posMap]) => {
        Object.entries(posMap).forEach(([pos,days]) => {
          Object.entries(days).forEach(([day,val]) => {
            csv += `${date},${pos},${day},${val?1:0}\n`;
          });
        });
      });

      const apiUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
      try {
        let r = await fetch(apiUrl, { headers: { Authorization: `token ${GITHUB_TOKEN}` } });
        let sha = null;
        if (r.ok) {
          const meta = await r.json(); sha = meta.sha;
        } else if (r.status !== 404) {
          throw new Error(`Lectura overrides.csv: ${r.status}`);
        }
        const content = btoa(unescape(encodeURIComponent(csv)));
        const payload = { message: `Actualiza overrides ${dateKey}`, content };
        if (sha) payload.sha = sha;
        r = await fetch(apiUrl, {
          method: 'PUT', headers: { Authorization: `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (!r.ok) throw new Error(`PUT overrides.csv: ${r.status}`);
        msgEl.style.color = 'green'; msgEl.textContent = 'Cambios guardados correctamente.';
      } catch (e) {
        msgEl.textContent = `Error: ${e.message}`;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const pwd = prompt('Ingrese contraseña:');
      if (pwd !== PASSWORD) { document.getElementById('authMessage').textContent = 'Acceso denegado'; return; }
      document.getElementById('adminContent').style.display = 'block';
      await loadData();
      let mon = getMonday(new Date());
      if (!scheduleMap[fmtDate(mon)]) mon = getMonday(new Date(weeks[0].split('/').reverse().join('-')));
      currentMonday = mon;
      document.getElementById('weekInput').value = currentMonday.toISOString().slice(0,10);
      renderTable(fmtDate(currentMonday));
      document.getElementById('prev').onclick = () => { currentMonday.setDate(currentMonday.getDate()-7); document.getElementById('weekInput').value=currentMonday.toISOString().slice(0,10); renderTable(fmtDate(currentMonday)); };
      document.getElementById('next').onclick = () => { currentMonday.setDate(currentMonday.getDate()+7); document.getElementById('weekInput').value=currentMonday.toISOString().slice(0,10); renderTable(fmtDate(currentMonday)); };
      document.getElementById('load').onclick = () => { const d=new Date(document.getElementById('weekInput').value); currentMonday=getMonday(d); renderTable(fmtDate(currentMonday)); };
      document.getElementById('saveChanges').onclick = saveChanges;
    });
  </script>
</body>
</html>
